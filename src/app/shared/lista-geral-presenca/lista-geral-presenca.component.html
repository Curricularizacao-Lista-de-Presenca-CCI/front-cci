<body>
  <div class="d-flex min-vh-100">
    <app-navbar></app-navbar>

    <app-navbar></app-navbar>

    <div class="flex-fill p-5" style="overflow-y: visible; min-height: 100vh;">

      <div class="content container-fluid p-0">
        <h2 class="titulo-principal text-primary fw-bold mb-5">Lista Geral de Presença</h2>

        <div class="caixa-lista shadow p-4 rounded">
          <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
            <div>
              <h5 class="titulo-lista mb-2">Evento {{ dadosEvento?.titulo }} - Lista de Alunos</h5>

              <div class="infos-lista d-flex gap-3">
                <span>Local: {{ dadosEvento?.local }}</span>
                <span>Servidor: {{ dadosEvento?.funcionario }}</span>
              </div>
            </div>
            <div class="acao-botoes d-flex align-items-center gap-4">

            <div class="acao-botoes d-flex align-items-center gap-2 flex-nowrap ms-auto">
              <div class="input-group busca me-2">
                <span class="input-group-text bg-white border-end-0">
                  <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text" class="form-control border-start-0" placeholder="Buscar" [(ngModel)]="termoBusca" />
              </div>

              <button class="btn btn-primary px-3 py-2 fs-6" (click)="abrirModalEditarChamada()"
                *ngIf="funcionarioLogado?.atuacao === 'C' && dadosEvento?.finalizado == false">Editar Evento
              </button>
              <div class="acao-botoes d-flex align-items-center gap-4">
                <button class="btn btn-primary px-3 py-2 fs-6" (click)="modoEdicaoPresenca = true"
                  *ngIf="funcionarioLogado?.atuacao === 'C' && dadosEvento?.finalizado == false && !modoEdicaoPresenca">
                  Editar Chamada
                </button>

              </div>
              <button class="btn btn-success px-3 py-2 fs-6" (click)="abrirModalChamada()"
                *ngIf="funcionarioLogado?.atuacao === 'C' && dadosEvento?.finalizado == false">Finalizar
                chamada
              </button>
            </div>
          </div>

          <div class="table-responsive mt-3">
            <table class="table tabela-membros">
              <thead>
                <tr>
                  <th class="d-flex justify-content-center">ID</th>
                  <th>Nome</th>
                  <th class="d-flex justify-content-center">Data do Evento</th>
                  <th class="d-flex justify-content-center">Presença</th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let aluno of alunosFiltrados">
                  <td data-label="ID" class="d-flex justify-content-center">{{ aluno.idAluno }}</td>
                  <td data-label="Nome">{{ aluno.nomeAluno }}</td>
                  <td data-label="Inscrição" class="d-flex justify-content-center">{{ aluno.data }}</td>

                  <td data-label="Status" class="d-flex justify-content-center align-items-center">
                    <span *ngIf="!modoEdicaoPresenca"
                      class="badge status {{ aluno.status == 'Sim' ? 'ativo' : 'inativo' }}">
                      {{ aluno.status }}
                    </span>

                    <ng-container *ngIf="modoEdicaoPresenca">
                      <input class="form-check-input fs-5" type="checkbox" [id]="'checkbox-' + aluno.idAluno"
                        [checked]="aluno.status === 'Sim'" (change)="atualizarStatusPresenca(aluno, $event)">

                      <label class="form-check-label visually-hidden" [for]="'checkbox-' + aluno.idAluno">
                        Presença
                      </label>
                    </ng-container>
                  </td>
                </tr>
              </tbody>

              <ng-container *ngIf="modoEdicaoPresenca">
                <div class="d-flex justify-content-end gap-2 mt-3">
                  <button class="btn btn-success px-3 py-2 fs-6" (click)="salvarPresencasEditadas()">
                    Salvar Presenças
                  </button>
                  <button class="btn btn-danger px-3 py-2 fs-6"
                    (click)="modoEdicaoPresenca = false; carregarAlunosOriginal()">
                    Cancelar
                  </button>
                </div>

              </ng-container>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>

<!-- Dialog de Edição de Chamada -->
<div class="modal fade" id="dialogEdicaoChamada" #dialogEdicaoChamadaRef tabindex="-1"
  aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Editar Evento {{ dadosEvento?.titulo }}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <form [formGroup]="chamadaForm" (ngSubmit)="EditarChamada()">

          <div class="mb-3">
            <label for="descricao" class="form-label">Nome do Evento</label>
            <input type="text" class="form-control" [value]="dadosEvento?.titulo" formControlName="titulo"
              id="descricao" placeholder="Informe o Nome do Evento">
          </div>

          <div class="mb-3">
            <label for="descricao" class="form-label">Local do Evento</label>
            <input type="text" class="form-control" [value]="dadosEvento?.local" formControlName="local" id="descricao"
              placeholder="Informe o Local do Evento">
          </div>

          <div class="mb-3">
            <label for="servidor" class="form-label">Alterar Servidor</label>
            <select class="form-select" id="servidor" formControlName="funcionario">
              <option [value]="dadosEvento?.idFuncionario">{{ dadosEvento?.funcionario }}</option>

              <option *ngFor="let func of opcoesAtuacaoFiltrada" [ngValue]="func.idFuncionario">
                {{ func.nome }}
              </option>
            </select>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
              <i class="bi bi-x"></i>Cancelar
            </button>

            <button type="submit" class="btn btn-success" [disabled]="chamadaForm.invalid">
              <i class="bi bi-check2"></i> Salvar
            </button>
          </div>
        </form>


      </div>
    </div>
  </div>
</div>

<!-- Dialog de Finalizar Chamada -->
<div class="modal fade" id="dialogFinalizarChamada" #dialogFinalizarChamadaRef tabindex="-1"
  aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="staticBackdropLabel">Finalizar Chamada</h1>
        <button type="button" class="btn-close" (click)="dialogFinalizarChamada = false" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="fw-bold">Deseja realmente finalizar a lista de chamada?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" (click)="dialogFinalizarChamada = false">Cancelar</button>

        <button type="button" (click)="finalizarChamada()" class="btn btn-success">
          Finalizar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="liveToast" #liveToastGeneric class="toast border-0" role="alert" aria-live="assertive" aria-atomic="true"
    [class]="toastClass">

    <div class="toast-header border-0" [class]="toastClass">
      <h1 class="modal-title fs-5">{{ mensagemToast }}</h1>

      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>

    <div class="toast-body">
      {{ mensagemToast }}
    </div>
  </div>
</div>
